#!/bin/bash

source "${MDS_SCRIPTS}/utils/ascii_menu.sh"

FORVO_MP3_BASE_URL="https://audio12.forvo.com/audios/mp3/"

function forvo_callback() {
    local mp3_audio_url="${mp3_url_list[${menu_index}]}"
    local mp3_filename="$(echo "${mp3_audio_url}" | awk -F '/' '{print $NF}')"
    local target_dir="/home/madophs/Downloads/language audios/english"
    wget -nc -qq "${mp3_audio_url}" -P '/tmp/audios' || cout error "Download failed"
    case ${key} in
        [pP])
            play "/tmp/audios/${mp3_filename}" &> /dev/null
            ;;
        [dD]|"")
            cp "/tmp/audios/${mp3_filename}" "${target_dir}/${searched_word}.mp3"
            play "${target_dir}/${searched_word}.mp3" &> /dev/null
            cout info "Saving '${searched_word}.mp3' to '${target_dir}'"
            return 1
            ;;
    esac
}

function forvo_audio_downloader() {
    local audio_url="$(xclip -selection clipboard -o)"
    local base_domain="$(echo "${audio_url}" | grep -o -e "https://[a-zA-Z\._]\+\.\(org\|com\)")"
    test "${base_domain}" != "https://forvo.com" && cout error "Invalid URL"
    local html_dom="$(lynx -source "${audio_url}")"
    local searched_word=$(echo "${audio_url}" | sed 's|\(.*\)\/word\/\([a-z]\+\).*|\2|g')
    local -a pronun_lang_list=( $(echo "${html_dom}" | grep -o '"pronunciations-list-[a-z_]\+"' | uniq) )
    local pronun_lang_blocks=$(echo "${html_dom}" | sed -n '/"pronunciations-list-[a-z_]\+"/,/<\/ul>/p')
    local -a pronun_users=( $(echo "${pronun_lang_blocks}" | grep -i -A2 -e 'pronunciation by' | grep 'data-p2' | sed 's|.*\(data-p2="\)\(.*\)\("\).*|\2|g') )
    local -a pronun_users_country=()
    mapfile -t pronun_users_country < <( echo "${pronun_lang_blocks}" | grep -o '(\(Male\|Female\) from.*)' | tr -d "()" )
    local -a mp3_url_list=( $(echo "${pronun_lang_blocks}" | grep -o 'Play(.*)' | cut -d ',' -f 5 | sed "s/'//g" | base64 --decode | sed "s|mp3|mp3\n|g" | sed "s|\(.*\)mp3|${FORVO_MP3_BASE_URL}\1mp3|g") )
    local -a forvo_menu=()
    for (( i=0; i<${#pronun_users[@]}; i+=1 ))
    do
        forvo_menu+=( "${pronun_users[${i}]} ${pronun_users_country[${i}]}" )
    done
    ascii_menu_add_trap
    ascii_menu_create "Choose audio:" forvo_menu "(P)lay (D)ownload (Q)uit" forvo_callback
}

forvo_audio_downloader
