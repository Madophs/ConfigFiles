#!/bin/bash

source "${MDS_SCRIPTS}/utils/ascii_menu.sh"

TARGET_DIR="/home/madophs/Downloads/language audios"
FORVO_MP3_BASE_URL="https://audio12.forvo.com/audios/mp3/"
BASE_AUDIO_DOMAIN=""
BASE_DOMAIN=""
HTML_DOM=""
SEARCHED_WORD=""
declare -a MENU=()
declare -a AUDIO_URL_LIST=()

function gaudio_callback() {
    local mp3_audio_url="${AUDIO_URL_LIST[${index_ref}]}"
    local mp3_filename="$(echo "${mp3_audio_url}" | awk -F '/' '{print $NF}')"
    wget -nc -qq "${mp3_audio_url}" -P '/tmp/audios' || cout error "Failed to download audio"
    case ${key} in
        [pP])
            (play "/tmp/audios/${mp3_filename}" &> /dev/null &)
            ;;
        [dD]|"")
            cp "/tmp/audios/${mp3_filename}" "${TARGET_DIR}/${SEARCHED_WORD}.mp3"
            (play "${TARGET_DIR}/${SEARCHED_WORD}.mp3" &> /dev/null &)
            cout info "Saving '${SEARCHED_WORD}.mp3' to '${TARGET_DIR}'"
            return 1
            ;;
    esac
}

function gaudio_set_vars() {
    BASE_DOMAIN="$(echo "${audio_url}" | grep -o -e "https://[a-zA-Z\._]\+\.\(org\|com\)")"
    HTML_DOM="$(lynx -connect-timeout=5000 -source "${audio_url}")" || cout error "Connection error"
    case "${BASE_DOMAIN}" in
        *cambridge*)
            BASE_AUDIO_DOMAIN="${BASE_DOMAIN}"

            # Trim word of the day
            local wotd_line_number=$(echo "${HTML_DOM}" | grep -m 1 -n -i 'word of the day' | grep -o '^[0-9]\+')
            if [[ -n "${wotd_line_number}" ]]
            then
                HTML_DOM=$(echo "${HTML_DOM}" | sed -n "1,${wotd_line_number}{p}")
            fi

            SEARCHED_WORD=$(echo "${audio_url}" | grep -o -e '[^\/]\+$')

            MENU=( $(echo "${HTML_DOM}" | grep -o '\/media.*\.mp3' | sort | uniq | sed "s|\(.*\)|${BASE_AUDIO_DOMAIN}\1|g") )
            AUDIO_URL_LIST=( "${MENU[@]}" )
            ;;
        *forvo*)
            BASE_AUDIO_DOMAIN="${FORVO_MP3_BASE_URL}"

            SEARCHED_WORD=$(echo "${audio_url}" | sed 's|\(.*\)\/word\/\([a-z]\+\).*|\2|g')

            local -a pronun_lang_list=( $(echo "${HTML_DOM}" | grep -o '"pronunciations-list-[a-z_]\+"' | uniq) )
            local pronun_lang_blocks=$(echo "${HTML_DOM}" | sed -n '/"pronunciations-list-[a-z_]\+"/,/<\/ul>/p')
            local -a pronun_users=( $(echo "${pronun_lang_blocks}" | grep -i -A2 -e 'pronunciation by' | grep 'data-p2' | sed 's|.*\(data-p2="\)\(.*\)\("\).*|\2|g') )
            local -a pronun_users_country=()
            mapfile -t pronun_users_country < <( echo "${pronun_lang_blocks}" | grep -o '(\(Male\|Female\) from.*)' | tr -d "()" )
            mapfile -t MENU < <( paste -d " " <(printf "%s\n" "${pronun_users[@]}") <(printf "%s\n" "${pronun_users_country[@]}"))
            AUDIO_URL_LIST=( $(echo "${pronun_lang_blocks}" | grep -o 'Play(.*)' | cut -d ',' -f 5 | sed "s/'//g" | base64 --decode | sed "s|mp3|mp3\n|g" | sed "s|\(.*\)mp3|${BASE_AUDIO_DOMAIN}\1mp3|g") )
            ;;
        *)
            cout error "Invalid URL"
            ;;
    esac
}

function gaudio() {
    local audio_url="$(xclip -selection clipboard -o)"
    gaudio_set_vars
    ascii_menu_add_trap
    ascii_menu_create "Choose audio for '${SEARCHED_WORD}':" MENU "(P)lay (D)ownload (Q)uit" gaudio_callback
}

gaudio
